{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"provenance":[],"gpuType":"T4","authorship_tag":"ABX9TyPRDJLm1+EkSsvXVeoO4Zn8"},"kernelspec":{"name":"python3","display_name":"Python 3"},"language_info":{"name":"python"},"accelerator":"GPU","widgets":{"application/vnd.jupyter.widget-state+json":{"f57191c396114fc7816c85637ff97d19":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_f7184558cef34be39eb958ad5e02ab54","IPY_MODEL_2da2577ed8ee4483b404c8d12aa22c4a","IPY_MODEL_ac1ca01ea7da4ca28c8016df1fd420e8"],"layout":"IPY_MODEL_de419c415f32468a908d7a448ff7a996"}},"f7184558cef34be39eb958ad5e02ab54":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_e10bf987ee3f4ca18b1d50c426369718","placeholder":"​","style":"IPY_MODEL_05d10b0c7658407aa79a74f3839480ed","value":"Map: 100%"}},"2da2577ed8ee4483b404c8d12aa22c4a":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"success","description":"","description_tooltip":null,"layout":"IPY_MODEL_2a1f5e3e850249b6956a9d79a621f296","max":8272,"min":0,"orientation":"horizontal","style":"IPY_MODEL_9946dd7cc15b435e8742f1b78e056601","value":8272}},"ac1ca01ea7da4ca28c8016df1fd420e8":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_e144964132c948e1b011a61e93eebfc7","placeholder":"​","style":"IPY_MODEL_641ae9e308ff4467bef07391eed0c9e8","value":" 8272/8272 [00:14&lt;00:00, 604.88 examples/s]"}},"de419c415f32468a908d7a448ff7a996":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e10bf987ee3f4ca18b1d50c426369718":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"05d10b0c7658407aa79a74f3839480ed":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"2a1f5e3e850249b6956a9d79a621f296":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"9946dd7cc15b435e8742f1b78e056601":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"e144964132c948e1b011a61e93eebfc7":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"641ae9e308ff4467bef07391eed0c9e8":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"94aa8cb46c864e4687a6ce3cec8e303f":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_1cac313dca684f10b4f22223afb9b2dd","IPY_MODEL_52d4086a3cc74b58820bf1f16419f73b","IPY_MODEL_26323d6aacca485496e1ac9607807bfe"],"layout":"IPY_MODEL_8daf9b2cda464aa5bb3c2f29ba90e7ac"}},"1cac313dca684f10b4f22223afb9b2dd":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_b665b011f7a34bd6bd2c65e0a386abfd","placeholder":"​","style":"IPY_MODEL_45ca0814235d4431a3f213c4859dbfaf","value":"Map: 100%"}},"52d4086a3cc74b58820bf1f16419f73b":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"success","description":"","description_tooltip":null,"layout":"IPY_MODEL_54d4da1c05a441b0a3d3dd7435a3e86b","max":919,"min":0,"orientation":"horizontal","style":"IPY_MODEL_d3a9a594ee194e24ab77643c79c3520f","value":919}},"26323d6aacca485496e1ac9607807bfe":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_834d117cb62b47a2a42f797ff0a69d2d","placeholder":"​","style":"IPY_MODEL_cdfd877372e74c5ca5e89824665c54a6","value":" 919/919 [00:01&lt;00:00, 549.05 examples/s]"}},"8daf9b2cda464aa5bb3c2f29ba90e7ac":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"b665b011f7a34bd6bd2c65e0a386abfd":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"45ca0814235d4431a3f213c4859dbfaf":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"54d4da1c05a441b0a3d3dd7435a3e86b":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d3a9a594ee194e24ab77643c79c3520f":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"834d117cb62b47a2a42f797ff0a69d2d":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"cdfd877372e74c5ca5e89824665c54a6":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}}}}},"cells":[{"cell_type":"code","execution_count":11,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Z7Z9VJlZihkT","executionInfo":{"status":"ok","timestamp":1755780113616,"user_tz":-540,"elapsed":7920,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"f1134570-75c2-4daf-eb88-f0192589587f"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}],"source":["from google.colab import drive\n","drive.mount('/content/drive')"]},{"cell_type":"code","source":["!pip -q install --no-cache-dir \\\n","  \"trl==0.9.6\" \\\n","  \"transformers==4.55.2\" \\\n","  \"peft==0.13.2\" \\\n","  \"accelerate==1.10.0\" \\\n","  \"datasets==2.20.0\" \\\n","  \"evaluate==0.4.2\" \\\n","  \"safetensors==0.4.3\"\n","\n","print(\"✅ Installed\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Kk5VsyzrrJHz","executionInfo":{"status":"ok","timestamp":1755780533091,"user_tz":-540,"elapsed":13073,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"6cb6b9f7-8f1e-4e87-dfe1-34e8e612e8d6"},"execution_count":14,"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m61.0/61.0 kB\u001b[0m \u001b[31m15.0 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m245.8/245.8 kB\u001b[0m \u001b[31m33.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m320.7/320.7 kB\u001b[0m \u001b[31m342.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m547.8/547.8 kB\u001b[0m \u001b[31m108.0 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m84.1/84.1 kB\u001b[0m \u001b[31m308.5 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m1.2/1.2 MB\u001b[0m \u001b[31m227.7 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m316.1/316.1 kB\u001b[0m \u001b[31m360.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m18.0/18.0 MB\u001b[0m \u001b[31m293.9 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m129.2/129.2 kB\u001b[0m \u001b[31m308.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25h\u001b[31mERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\n","opencv-python 4.12.0.88 requires numpy<2.3.0,>=2; python_version >= \"3.9\", but you have numpy 1.26.4 which is incompatible.\n","thinc 8.3.6 requires numpy<3.0.0,>=2.0.0, but you have numpy 1.26.4 which is incompatible.\n","opencv-python-headless 4.12.0.88 requires numpy<2.3.0,>=2; python_version >= \"3.9\", but you have numpy 1.26.4 which is incompatible.\n","opencv-contrib-python 4.12.0.88 requires numpy<2.3.0,>=2; python_version >= \"3.9\", but you have numpy 1.26.4 which is incompatible.\n","gcsfs 2025.3.0 requires fsspec==2025.3.0, but you have fsspec 2024.5.0 which is incompatible.\u001b[0m\u001b[31m\n","\u001b[0m✅ Installed\n"]}]},{"cell_type":"markdown","source":["# **파인 튜닝**"],"metadata":{"id":"ShkgbESNc6Yi"}},{"cell_type":"code","source":["import platform, torch\n","import transformers, trl, peft, datasets, accelerate\n","\n","print(\"Python       :\", platform.python_version())\n","print(\"Torch        :\", torch.__version__, \"| CUDA:\", torch.cuda.is_available())\n","print(\"transformers :\", transformers.__version__)\n","print(\"trl          :\", trl.__version__)\n","print(\"peft         :\", peft.__version__)\n","print(\"datasets     :\", datasets.__version__)\n","print(\"accelerate   :\", accelerate.__version__)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"ZQ10zMAJrpZ1","executionInfo":{"status":"ok","timestamp":1755780653356,"user_tz":-540,"elapsed":10,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"44166836-5d86-4aab-b3fd-52a1e4617f5d"},"execution_count":15,"outputs":[{"output_type":"stream","name":"stdout","text":["Python       : 3.12.11\n","Torch        : 2.8.0+cu126 | CUDA: True\n","transformers : 4.55.2\n","trl          : 0.9.6\n","peft         : 0.17.0\n","datasets     : 4.0.0\n","accelerate   : 1.10.0\n"]}]},{"cell_type":"code","source":["import sys, subprocess, torch\n","\n","def try_install_flash_attn():\n","    if not torch.cuda.is_available():\n","        return False\n","    major, _ = torch.cuda.get_device_capability(0)\n","    if major < 8:\n","        return False\n","    try:\n","        __import__(\"flash_attn\")\n","        return True\n","    except Exception:\n","        pass\n","    try:\n","        subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"--no-cache-dir\", \"flash-attn\"], stdout=subprocess.DEVNULL)\n","        __import__(\"flash_attn\")\n","        return True\n","    except Exception:\n","        return False\n","\n","FLASH_OK = try_install_flash_attn()\n","ATTN_IMPL = \"flash_attention_2\" if FLASH_OK else \"sdpa\"\n","print(f\"GPU: {torch.cuda.is_available()} | FlashAttention OK: {FLASH_OK} → attn_implementation='{ATTN_IMPL}'\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"zKQds_5Piuda","executionInfo":{"status":"ok","timestamp":1755779943668,"user_tz":-540,"elapsed":45,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"e4e68f58-a69b-4a59-ddcd-4a2a65ddca8f"},"execution_count":6,"outputs":[{"output_type":"stream","name":"stdout","text":["GPU: True | FlashAttention OK: False → attn_implementation='sdpa'\n"]}]},{"cell_type":"code","source":["from pathlib import Path\n","\n","ROOT     = \"/content/drive/MyDrive/Summarize\"\n","DATA_DIR = f\"{ROOT}/dataset_chat\"   # train_sum_chat.CLEAN.jsonl / val_sum_chat.CLEAN.jsonl\n","OUT_DIR  = f\"{ROOT}/models\"\n","\n","SFT_ADAPTER_DIR = f\"{OUT_DIR}/qwen2_sum_lora_sft\"\n","DPO_ADAPTER_DIR = f\"{OUT_DIR}/qwen2_sum_lora_dpo\"\n","\n","BASE_MODEL = \"Qwen/Qwen2-1.5B-Instruct\"\n","\n","BAD_CHARS = [\"。\",\"、\",\"｡\",\"､\",\"「\",\"」\",\"�\"]  # 일본식 마침표/쉼표/괄호/깨짐문자"],"metadata":{"id":"La7Y5rj8ivEJ","executionInfo":{"status":"ok","timestamp":1755779992744,"user_tz":-540,"elapsed":4,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}}},"execution_count":7,"outputs":[]},{"cell_type":"code","source":["import torch, warnings\n","from transformers import AutoTokenizer, AutoModelForCausalLM\n","\n","tokenizer = AutoTokenizer.from_pretrained(BASE_MODEL, use_fast=True, trust_remote_code=True)\n","if tokenizer.pad_token is None:\n","    tokenizer.pad_token = tokenizer.eos_token\n","tokenizer.padding_side = \"left\"\n","\n","dtype = torch.bfloat16 if (torch.cuda.is_available() and torch.cuda.get_device_capability(0)[0] >= 8) else torch.float16\n","\n","model = AutoModelForCausalLM.from_pretrained(\n","    BASE_MODEL,\n","    torch_dtype=dtype,\n","    low_cpu_mem_usage=False,\n","    attn_implementation=ATTN_IMPL,\n",")\n","model.to(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n","\n","print(\"model ready:\", BASE_MODEL, \"| device:\", next(model.parameters()).device, \"| attn:\", ATTN_IMPL)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"oabCSQuDivCf","executionInfo":{"status":"ok","timestamp":1755780007122,"user_tz":-540,"elapsed":12159,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"aa5652a3-cd73-4764-e7ba-1a7566ed36f1"},"execution_count":8,"outputs":[{"output_type":"stream","name":"stdout","text":["model ready: Qwen/Qwen2-1.5B-Instruct | device: cuda:0 | attn: sdpa\n"]}]},{"cell_type":"code","source":["import os, json\n","from torch.utils.data import Dataset\n","from datasets import Dataset as HFDataset\n","\n","TRAIN_JSONL = f\"{DATA_DIR}/train_sum_chat.CLEAN.jsonl\"\n","VAL_JSONL   = f\"{DATA_DIR}/val_sum_chat.CLEAN.jsonl\"\n","\n","assert Path(TRAIN_JSONL).exists(), f\"학습 파일 없음: {TRAIN_JSONL}\"\n","assert Path(VAL_JSONL).exists(),   f\"검증 파일 없음: {VAL_JSONL}\"\n","\n","class ChatJsonlDataset(Dataset):\n","    def __init__(self, path):\n","        self.rows = []\n","        with open(path, \"r\", encoding=\"utf-8\") as f:\n","            for line in f:\n","                if not line.strip(): continue\n","                obj = json.loads(line)\n","                msgs = obj.get(\"messages\")\n","                if not msgs or not isinstance(msgs, list): continue\n","                self.rows.append({\"messages\": msgs, \"id\": obj.get(\"id\")})\n","    def __len__(self): return len(self.rows)\n","    def __getitem__(self, idx): return self.rows[idx]\n","\n","train_dataset = ChatJsonlDataset(TRAIN_JSONL)\n","val_dataset   = ChatJsonlDataset(VAL_JSONL)\n","\n","def formatting_func(example):\n","    text = tokenizer.apply_chat_template(\n","        example[\"messages\"],\n","        tokenize=False,\n","        add_generation_prompt=False\n","    )\n","    return text\n","\n","hf_train = HFDataset.from_dict({\"text\": [formatting_func(ex) for ex in train_dataset]})\n","hf_val   = HFDataset.from_dict({\"text\": [formatting_func(ex) for ex in val_dataset]})\n","\n","MAX_SEQ_LEN = 1024\n","print(f\"train samples: {len(hf_train)} | val samples: {len(hf_val)}\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"sHH5xfx5ivAj","executionInfo":{"status":"ok","timestamp":1755780134744,"user_tz":-540,"elapsed":4481,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"b02e69ca-f5f5-4ff9-c008-16e168affe0e"},"execution_count":12,"outputs":[{"output_type":"stream","name":"stdout","text":["train samples: 8272 | val samples: 919\n"]}]},{"cell_type":"code","source":["from peft import LoraConfig\n","from trl import SFTTrainer, SFTConfig\n","\n","if hasattr(model, \"gradient_checkpointing_enable\"):\n","    model.gradient_checkpointing_enable()\n","if hasattr(model, \"enable_input_require_grads\"):\n","    model.enable_input_require_grads()\n","\n","target_modules = [\"q_proj\",\"k_proj\",\"v_proj\",\"o_proj\",\"gate_proj\",\"up_proj\",\"down_proj\"]\n","\n","peft_config = LoraConfig(\n","    r=16,\n","    lora_alpha=32,\n","    lora_dropout=0.05,\n","    bias=\"none\",\n","    task_type=\"CAUSAL_LM\",\n","    target_modules=target_modules,\n",")\n","\n","def build_sft_config():\n","    common = dict(\n","        output_dir=SFT_ADAPTER_DIR,\n","        per_device_train_batch_size=1,\n","        per_device_eval_batch_size=1,\n","        gradient_accumulation_steps=16,\n","        learning_rate=2e-4,\n","        num_train_epochs=2,\n","        logging_steps=20,\n","        save_steps=200,\n","        eval_steps=200,\n","        save_total_limit=2,\n","        lr_scheduler_type=\"cosine\",\n","        warmup_ratio=0.03,\n","        bf16=torch.cuda.is_available() and torch.cuda.is_bf16_supported(),\n","        fp16=torch.cuda.is_available() and not torch.cuda.is_bf16_supported(),\n","        gradient_checkpointing=True,\n","        report_to=[],\n","        max_seq_length=MAX_SEQ_LEN,\n","        dataset_text_field=\"text\",\n","        packing=False,\n","    )\n","    try:\n","        return SFTConfig(evaluation_strategy=\"steps\", **common)\n","    except TypeError:\n","        return SFTConfig(eval_strategy=\"steps\", **common)\n","\n","sft_config = build_sft_config()\n","\n","sft_trainer = SFTTrainer(\n","    model=model,\n","    tokenizer=tokenizer,\n","    args=sft_config,\n","    train_dataset=hf_train,\n","    eval_dataset=hf_val,\n","    peft_config=peft_config,\n",")\n","\n","trainable = sum(p.numel() for p in sft_trainer.model.parameters() if p.requires_grad)\n","total     = sum(p.numel() for p in sft_trainer.model.parameters())\n","print(f\"trainable params: {trainable:,} / {total:,} ({trainable/total:.2%})\")\n","assert trainable > 0, \"LoRA 파라미터가 열리지 않았습니다!\"\n","\n","train_result = sft_trainer.train()\n","print(train_result)\n","\n","Path(SFT_ADAPTER_DIR).mkdir(parents=True, exist_ok=True)\n","sft_trainer.model.save_pretrained(SFT_ADAPTER_DIR)\n","tokenizer.save_pretrained(SFT_ADAPTER_DIR)\n","\n","metrics = sft_trainer.evaluate()\n","print(\"eval metrics:\", metrics)\n","print(f\"✅ SFT LoRA saved to: {SFT_ADAPTER_DIR}\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":497,"referenced_widgets":["f57191c396114fc7816c85637ff97d19","f7184558cef34be39eb958ad5e02ab54","2da2577ed8ee4483b404c8d12aa22c4a","ac1ca01ea7da4ca28c8016df1fd420e8","de419c415f32468a908d7a448ff7a996","e10bf987ee3f4ca18b1d50c426369718","05d10b0c7658407aa79a74f3839480ed","2a1f5e3e850249b6956a9d79a621f296","9946dd7cc15b435e8742f1b78e056601","e144964132c948e1b011a61e93eebfc7","641ae9e308ff4467bef07391eed0c9e8","94aa8cb46c864e4687a6ce3cec8e303f","1cac313dca684f10b4f22223afb9b2dd","52d4086a3cc74b58820bf1f16419f73b","26323d6aacca485496e1ac9607807bfe","8daf9b2cda464aa5bb3c2f29ba90e7ac","b665b011f7a34bd6bd2c65e0a386abfd","45ca0814235d4431a3f213c4859dbfaf","54d4da1c05a441b0a3d3dd7435a3e86b","d3a9a594ee194e24ab77643c79c3520f","834d117cb62b47a2a42f797ff0a69d2d","cdfd877372e74c5ca5e89824665c54a6"]},"id":"_XoW0OGDiu-P","executionInfo":{"status":"ok","timestamp":1755856953408,"user_tz":-540,"elapsed":75674277,"user":{"displayName":"Jiyeon Park","userId":"09096726220726434656"}},"outputId":"d9f317f8-d1e2-4e79-db1a-7b892f987f09"},"execution_count":16,"outputs":[{"output_type":"display_data","data":{"text/plain":["Map:   0%|          | 0/8272 [00:00<?, ? examples/s]"],"application/vnd.jupyter.widget-view+json":{"version_major":2,"version_minor":0,"model_id":"f57191c396114fc7816c85637ff97d19"}},"metadata":{}},{"output_type":"display_data","data":{"text/plain":["Map:   0%|          | 0/919 [00:00<?, ? examples/s]"],"application/vnd.jupyter.widget-view+json":{"version_major":2,"version_minor":0,"model_id":"94aa8cb46c864e4687a6ce3cec8e303f"}},"metadata":{}},{"output_type":"stream","name":"stderr","text":["/usr/local/lib/python3.12/dist-packages/trl/trainer/sft_trainer.py:408: UserWarning: You passed a tokenizer with `padding_side` not equal to `right` to the SFTTrainer. This might lead to some unexpected behaviour due to overflow issues when training a model in half-precision. You might consider adding `tokenizer.padding_side = 'right'` to your code.\n","  warnings.warn(\n","/usr/local/lib/python3.12/dist-packages/trl/trainer/sft_trainer.py:413: FutureWarning: `tokenizer` is deprecated and will be removed in version 5.0.0 for `SFTTrainer.__init__`. Use `processing_class` instead.\n","  super().__init__(\n"]},{"output_type":"stream","name":"stdout","text":["trainable params: 18,464,768 / 1,562,179,072 (1.18%)\n"]},{"output_type":"stream","name":"stderr","text":["`use_cache=True` is incompatible with gradient checkpointing. Setting `use_cache=False`.\n"]},{"output_type":"display_data","data":{"text/plain":["<IPython.core.display.HTML object>"],"text/html":["\n","    <div>\n","      \n","      <progress value='1034' max='1034' style='width:300px; height:20px; vertical-align: middle;'></progress>\n","      [1034/1034 20:38:56, Epoch 2/2]\n","    </div>\n","    <table border=\"1\" class=\"dataframe\">\n","  <thead>\n"," <tr style=\"text-align: left;\">\n","      <th>Step</th>\n","      <th>Training Loss</th>\n","      <th>Validation Loss</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <td>200</td>\n","      <td>1.280700</td>\n","      <td>1.269565</td>\n","    </tr>\n","    <tr>\n","      <td>400</td>\n","      <td>1.218200</td>\n","      <td>1.192835</td>\n","    </tr>\n","    <tr>\n","      <td>600</td>\n","      <td>1.100400</td>\n","      <td>1.130877</td>\n","    </tr>\n","    <tr>\n","      <td>800</td>\n","      <td>1.068400</td>\n","      <td>1.090529</td>\n","    </tr>\n","    <tr>\n","      <td>1000</td>\n","      <td>1.058900</td>\n","      <td>1.079829</td>\n","    </tr>\n","  </tbody>\n","</table><p>"]},"metadata":{}},{"output_type":"stream","name":"stdout","text":["TrainOutput(global_step=1034, training_loss=1.1891585291008424, metrics={'train_runtime': 74396.0454, 'train_samples_per_second': 0.222, 'train_steps_per_second': 0.014, 'total_flos': 1.125907425527808e+17, 'train_loss': 1.1891585291008424, 'epoch': 2.0})\n"]},{"output_type":"display_data","data":{"text/plain":["<IPython.core.display.HTML object>"],"text/html":["\n","    <div>\n","      \n","      <progress value='919' max='919' style='width:300px; height:20px; vertical-align: middle;'></progress>\n","      [919/919 20:51]\n","    </div>\n","    "]},"metadata":{}},{"output_type":"stream","name":"stdout","text":["eval metrics: {'eval_loss': 1.079799771308899, 'eval_runtime': 1252.5452, 'eval_samples_per_second': 0.734, 'eval_steps_per_second': 0.734, 'epoch': 2.0}\n","✅ SFT LoRA saved to: /content/drive/MyDrive/Summarize/models/qwen2_sum_lora_sft\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"eWQrB7j6p1cN"},"execution_count":null,"outputs":[]}]}